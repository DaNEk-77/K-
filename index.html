<!DOCTYPE html>
<html lang="pl">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Quiz: Polskie nazwy państw na świecie</title>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />
    <style>
      html, body {
        height: 100%;
        margin: 0;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
        background: #f6f7f9;
        color: #222;
      }

      .app {
        display: flex;
        height: 100vh;
        width: 100vw;
        overflow: hidden;
      }

      .sidebar {
        width: 300px;
        min-width: 260px;
        max-width: 420px;
        background: #ffffff;
        border-right: 1px solid #e5e7eb;
        display: flex;
        flex-direction: column;
      }

      .sidebar header {
        padding: 14px 16px 10px;
        border-bottom: 1px solid #eef0f2;
      }

      .sidebar h1 {
        margin: 0 0 6px;
        font-size: 16px;
        font-weight: 600;
      }

      .controls {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }

      .controls button {
        appearance: none;
        border: 1px solid #d1d5db;
        background: #fff;
        padding: 6px 10px;
        border-radius: 6px;
        font-size: 13px;
        cursor: pointer;
      }

      .controls button.primary {
        background: #2563eb;
        color: #fff;
        border-color: #2563eb;
      }

      .controls button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .list {
        padding: 8px 12px 12px;
        overflow: auto;
      }

      .list .search {
        margin: 4px 0 10px;
      }

      .list input[type="text"] {
        width: 100%;
        padding: 8px 10px;
        border-radius: 6px;
        border: 1px solid #d1d5db;
        font-size: 14px;
      }

      .cities {
        list-style: none;
        padding: 0;
        margin: 8px 0 0;
        max-height: calc(100vh - 210px);
        overflow: auto;
      }

      .cities li {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 6px 4px;
        border-radius: 6px;
      }

      .cities li:hover {
        background: #f3f4f6;
      }

      .main {
        position: relative;
        flex: 1;
        display: flex;
        align-items: stretch;
        justify-content: center;
        background: #e5e7eb;
      }

      #map {
        height: 100%;
        width: 100%;
      }

      /* Ulepszenia mobilne: pełna szerokość panelu wyboru */
      @media (max-width: 768px) {
        .sidebar {
          width: 100%;
          max-width: none;
        }
      }

      .hud {
        position: absolute;
        top: 12px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 12px;
        background: rgba(255, 255, 255, 0.9);
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        padding: 8px 12px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        font-size: 14px;
        z-index: 500;
      }

      .hud .target {
        font-weight: 600;
      }

      .toast {
        position: absolute;
        bottom: 16px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(17,24,39,0.9);
        color: #fff;
        padding: 10px 14px;
        border-radius: 8px;
        font-size: 14px;
        display: none;
        z-index: 600;
      }

      .footer {
        position: absolute;
        bottom: 10px;
        right: 10px;
        background: rgba(255,255,255,0.85);
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 6px 10px;
        font-size: 12px;
        z-index: 500;
      }
    </style>
  </head>
  <body>
    <div class="app">
      <aside class="sidebar">
        <header>
          <h1>Polskie nazwy państw na świecie</h1>
          <div class="controls">
            <button id="selectAll">Zaznacz wszystkie</button>
            <button id="deselectAll">Odznacz wszystkie</button>
            <label for="sort" style="margin-left:auto; font-size:12px; align-self:center;">Sortuj:</label>
            <select id="sort" style="border:1px solid #d1d5db; border-radius:6px; padding:6px 8px; font-size:13px;">
              <option value="name-asc">A → Z</option>
              <option value="name-desc">Z → A</option>
              <option value="pop-desc">Populacja ↓</option>
              <option value="pop-asc">Populacja ↑</option>
            </select>
            <input id="pickCount" type="number" min="1" value="10" title="Ile pierwszych zaznaczyć" style="width:72px; padding:6px 8px; border:1px solid #d1d5db; border-radius:6px; font-size:13px;" />
            <button id="pickTop">Wybierz X pierwszych</button>
            <button id="startBtn" class="primary">Start</button>
            <button id="resetBtn">Reset</button>
          </div>
        </header>
        <div class="list">
          <div class="search">
            <input id="search" type="text" placeholder="Szukaj państwa..." />
          </div>
          <ul id="countryList" class="cities"></ul>
        </div>
      </aside>
      <main class="main">
        <div id="map"></div>
        <div class="hud" id="hud" style="display:none;">
          <div>Cel: <span class="target" id="targetName">—</span></div>
          <div>Punkty: <span id="score">0</span></div>
          <div>Postęp: <span id="progress">0/0</span></div>
        </div>
        <div class="toast" id="toast"></div>
        <div class="footer">Warstwa: CartoDB Positron No Labels • Dane © OpenStreetMap</div>
      </main>
    </div>

    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>
    <script>
      // --- Dane: państwa z pliku panstwa.txt ---
      const COUNTRY_DATA = [
        { name: 'Afganistan', lat: 33.9, lng: 67.7 },
        { name: 'Albania', lat: 41.2, lng: 20.2 },
        { name: 'Algieria', lat: 28.0, lng: 1.7 },
        { name: 'Kenia', lat: 0.0, lng: 37.9 },
        { name: 'Arabia Saudyjska', lat: 23.9, lng: 45.1 },
        { name: 'Kiribati', lat: 1.9, lng: -157.4 },
        { name: 'Kanada', lat: 56.1, lng: -106.3 },
        { name: 'Katar', lat: 25.4, lng: 51.2 },
        { name: 'Kazachstan', lat: 48.0, lng: 66.9 },
        { name: 'Słowacja', lat: 48.7, lng: 19.7 },
        { name: 'Somalia', lat: 5.2, lng: 46.2 },
        { name: 'Stany Zjednoczone', lat: 39.8, lng: -98.6 },
        { name: 'Syria', lat: 34.8, lng: 39.0 },
        { name: 'Szwajcaria', lat: 46.8, lng: 8.2 },
        { name: 'Argentyna', lat: -38.4, lng: -63.6 },
        { name: 'Kolumbia', lat: 4.6, lng: -74.3 },
        { name: 'Szwecja', lat: 60.1, lng: 18.6 },
        { name: 'Australia', lat: -25.3, lng: 133.8 },
        { name: 'Korea Południowa', lat: 36.5, lng: 127.9 },
        { name: 'Tanzania', lat: -6.4, lng: 34.9 },
        { name: 'Austria', lat: 47.6, lng: 13.8 },
        { name: 'Korea Północna', lat: 40.3, lng: 127.5 },
        { name: 'Tunezja', lat: 33.9, lng: 9.5 },
        { name: 'Bangladesz', lat: 23.7, lng: 90.4 },
        { name: 'Kostaryka', lat: 9.7, lng: -83.8 },
        { name: 'Turcja', lat: 39.0, lng: 35.2 },
        { name: 'Białoruś', lat: 53.7, lng: 27.9 },
        { name: 'Kuba', lat: 21.5, lng: -77.8 },
        { name: 'Ukraina', lat: 49.0, lng: 31.4 },
        { name: 'Boliwia', lat: -16.3, lng: -63.6 },
        { name: 'Liban', lat: 33.9, lng: 35.9 },
        { name: 'Brazylia', lat: -14.2, lng: -51.9 },
        { name: 'Bulgaria', lat: 42.7, lng: 25.5 },
        { name: 'Chile', lat: -35.7, lng: -71.5 },
        { name: 'Chiny', lat: 35.9, lng: 104.2 },
        { name: 'Chorwacja', lat: 45.1, lng: 15.2 },
        { name: 'Cypr', lat: 35.1, lng: 33.4 },
        { name: 'Czad', lat: 15.5, lng: 18.7 },
        { name: 'Czechy', lat: 49.8, lng: 15.5 },
        { name: 'Dania', lat: 56.3, lng: 9.5 },
        { name: 'Dominikana', lat: 18.7, lng: -70.2 },
        { name: 'Egipt', lat: 26.8, lng: 30.8 },
        { name: 'Ekwador', lat: -1.8, lng: -78.2 },
        { name: 'Etiopia', lat: 9.1, lng: 40.5 },
        { name: 'Liberia', lat: 6.4, lng: -9.4 },
        { name: 'Libia', lat: 26.3, lng: 17.2 },
        { name: 'Madagaskar', lat: -18.8, lng: 46.9 },
        { name: 'Malediwy', lat: 3.2, lng: 73.2 },
        { name: 'Malezja', lat: 4.2, lng: 102.0 },
        { name: 'Maroko', lat: 31.8, lng: -7.1 },
        { name: 'Mauritius', lat: -20.3, lng: 57.6 },
        { name: 'Meksyk', lat: 23.6, lng: -102.5 },
        { name: 'Mongolia', lat: 46.9, lng: 103.8 },
        { name: 'Mozambik', lat: -18.7, lng: 35.5 },
        { name: 'Namibia', lat: -23.0, lng: 18.5 },
        { name: 'Nepal', lat: 28.4, lng: 84.1 },
        { name: 'Niemcy', lat: 51.2, lng: 10.5 },
        { name: 'Urugwaj', lat: -32.5, lng: -55.8 },
        { name: 'Uzbekistan', lat: 41.4, lng: 64.6 },
        { name: 'Wenezuela', lat: 6.4, lng: -66.6 },
        { name: 'Węgry', lat: 47.1, lng: 19.5 },
        { name: 'Wielka Brytania', lat: 55.4, lng: -3.4 },
        { name: 'Wietnam', lat: 14.1, lng: 108.3 },
        { name: 'Włochy', lat: 42.5, lng: 12.5 },
        { name: 'Zambia', lat: -13.1, lng: 27.8 },
        { name: 'Zimbabwe', lat: -19.0, lng: 29.2 },
        { name: 'Filipiny', lat: 12.9, lng: 121.8 },
        { name: 'Finlandia', lat: 64.5, lng: 26.0 },
        { name: 'Francja', lat: 46.2, lng: 2.2 },
        { name: 'Niger', lat: 17.6, lng: 8.1 },
        { name: 'Nigeria', lat: 9.1, lng: 8.7 },
        { name: 'Nikaragua', lat: 12.9, lng: -85.2 },
        { name: 'Grecja', lat: 39.1, lng: 21.8 },
        { name: 'Gruzja', lat: 42.3, lng: 43.4 },
        { name: 'Gwatemala', lat: 15.8, lng: -90.2 },
        { name: 'Hiszpania', lat: 40.5, lng: -3.7 },
        { name: 'Holandia', lat: 52.1, lng: 5.3 },
        { name: 'Indie', lat: 20.6, lng: 78.9 },
        { name: 'Indonezja', lat: -2.5, lng: 118.0 },
        { name: 'Irak', lat: 33.2, lng: 43.7 },
        { name: 'Iran', lat: 32.4, lng: 53.7 },
        { name: 'Norwegia', lat: 60.5, lng: 8.5 },
        { name: 'Nowa Zelandia', lat: -41.3, lng: 174.8 },
        { name: 'Oman', lat: 21.5, lng: 55.9 },
        { name: 'Pakistan', lat: 30.4, lng: 69.3 },
        { name: 'Panama', lat: 8.5, lng: -80.8 },
        { name: 'Papua-Nowa Gwinea', lat: -6.3, lng: 144.0 },
        { name: 'Paragwaj', lat: -23.4, lng: -58.4 },
        { name: 'Peru', lat: -9.2, lng: -75.0 },
        { name: 'Polska', lat: 52.1, lng: 19.4 },
        { name: 'Irlandia', lat: 53.1, lng: -8.2 },
        { name: 'Portugalia', lat: 39.4, lng: -8.2 },
        { name: 'Islandia', lat: 64.9, lng: -19.0 },
        { name: 'Rosja', lat: 61.5, lng: 105.3 },
        { name: 'Izrael', lat: 31.0, lng: 35.0 },
        { name: 'Rumunia', lat: 45.9, lng: 25.1 },
        { name: 'Jamajka', lat: 18.1, lng: -77.3 },
        { name: 'Seszele', lat: -4.7, lng: 55.5 },
        { name: 'Japonia', lat: 36.2, lng: 138.3 },
        { name: 'Singapur', lat: 1.3521, lng: 103.8198 }
      ];

      // --- Inicjalizacja listy państw ---
      const countryListEl = document.getElementById('countryList');
      const searchEl = document.getElementById('search');
      const startBtn = document.getElementById('startBtn');
      const resetBtn = document.getElementById('resetBtn');
      const selectAllBtn = document.getElementById('selectAll');
      const deselectAllBtn = document.getElementById('deselectAll');
      const hud = document.getElementById('hud');
      const scoreEl = document.getElementById('score');
      const progressEl = document.getElementById('progress');
      const targetNameEl = document.getElementById('targetName');
      const toastEl = document.getElementById('toast');
      const sortEl = document.getElementById('sort');
      const pickCountEl = document.getElementById('pickCount');
      const pickTopBtn = document.getElementById('pickTop');
      const appEl = document.querySelector('.app');
      const sidebarEl = document.querySelector('.sidebar');
      const mainEl = document.querySelector('.main');

      // Dynamiczne dodanie trybu quizu (klik/wpisywanie) i pola odpowiedzi
      const controlsEl = document.querySelector('.controls');
      let modeEl = document.getElementById('mode');
      if (!modeEl && controlsEl && sortEl) {
        const modeLabel = document.createElement('label');
        modeLabel.setAttribute('for', 'mode');
        modeLabel.style.marginLeft = '6px';
        modeLabel.style.fontSize = '12px';
        modeLabel.style.alignSelf = 'center';
        modeLabel.textContent = 'Tryb:';

        modeEl = document.createElement('select');
        modeEl.id = 'mode';
        modeEl.title = 'Wybierz tryb quizu';
        modeEl.style.border = '1px solid #d1d5db';
        modeEl.style.borderRadius = '6px';
        modeEl.style.padding = '6px 8px';
        modeEl.style.fontSize = '13px';

        const optClick = document.createElement('option');
        optClick.value = 'click';
        optClick.textContent = 'Klikanie na mapie';
        const optType = document.createElement('option');
        optType.value = 'type';
        optType.textContent = 'Wpisywanie nazw';
        const optTypeTarget = document.createElement('option');
        optTypeTarget.value = 'type-target';
        optTypeTarget.textContent = 'Wpisywanie wskazanego';
        modeEl.append(optClick, optType, optTypeTarget);

        // Wstaw za selectem sortowania
        sortEl.insertAdjacentElement('afterend', modeEl);
        sortEl.insertAdjacentElement('afterend', modeLabel);
      }

      // Pole do wpisywania odpowiedzi w HUD (tworzone dynamicznie)
      let typeBox = document.getElementById('typeBox');
      let answerInput = document.getElementById('answerInput');
      let answerBtn = document.getElementById('answerBtn');
      let hudMsgEl = document.getElementById('hudMsg');
      let idkBtn = document.getElementById('idkBtn');
      const targetContainer = targetNameEl ? targetNameEl.closest('div') : null;
      if (!typeBox && hud) {
        typeBox = document.createElement('div');
        typeBox.id = 'typeBox';
        typeBox.style.display = 'none';
        typeBox.style.gap = '6px';
        typeBox.style.alignItems = 'center';

        answerInput = document.createElement('input');
        answerInput.id = 'answerInput';
        answerInput.type = 'text';
        answerInput.placeholder = 'Wpisz nazwę państwa i Enter';
        answerInput.style.padding = '6px 8px';
        answerInput.style.border = '1px solid #d1d5db';
        answerInput.style.borderRadius = '6px';
        answerInput.style.fontSize = '13px';
        answerInput.style.width = '220px';

        answerBtn = document.createElement('button');
        answerBtn.id = 'answerBtn';
        answerBtn.textContent = 'OK';
        answerBtn.style.appearance = 'none';
        answerBtn.style.border = '1px solid #2563eb';
        answerBtn.style.background = '#2563eb';
        answerBtn.style.color = '#fff';
        answerBtn.style.padding = '6px 10px';
        answerBtn.style.borderRadius = '6px';
        answerBtn.style.fontSize = '13px';
        answerBtn.style.cursor = 'pointer';

        idkBtn = document.createElement('button');
        idkBtn.id = 'idkBtn';
        idkBtn.textContent = 'Nie wiem';
        idkBtn.title = 'Pomiń to pytanie';
        idkBtn.style.appearance = 'none';
        idkBtn.style.border = '1px solid #6b7280';
        idkBtn.style.background = '#fff';
        idkBtn.style.color = '#111827';
        idkBtn.style.padding = '6px 10px';
        idkBtn.style.borderRadius = '6px';
        idkBtn.style.fontSize = '13px';
        idkBtn.style.cursor = 'pointer';
        idkBtn.style.display = 'none';

        typeBox.appendChild(answerInput);
        typeBox.appendChild(answerBtn);
        typeBox.appendChild(idkBtn);
        hud.appendChild(typeBox);
      }

      if (!hudMsgEl && hud) {
        hudMsgEl = document.createElement('span');
        hudMsgEl.id = 'hudMsg';
        hudMsgEl.style.marginLeft = '8px';
        hudMsgEl.style.fontSize = '13px';
        hudMsgEl.style.color = '#374151';
        hudMsgEl.style.display = 'none';
        hud.appendChild(hudMsgEl);
      }

      // Populacja (przybliżone wartości) – tylko do sortowania
      const POP_BY_COUNTRY = {
        'Afganistan': 40300000,
        'Albania': 2830000,
        'Algieria': 44900000,
        'Kenia': 54000000,
        'Arabia Saudyjska': 35800000,
        'Kiribati': 130000,
        'Kanada': 38000000,
        'Katar': 2800000,
        'Kazachstan': 19000000,
        "S2owacja": 5450000,
        'Somalia': 17000000,
        'Stany Zjednoczone': 333000000,
        'Syria': 21000000,
        'Szwajcaria': 8700000,
        'Argentyna': 45700000,
        'Kolumbia': 51500000,
        'Szwecja': 10400000,
        'Australia': 26000000,
        "Korea Po2udniowa": 51700000,
        'Tanzania': 65000000,
        'Austria': 9000000,
        "Korea P32nocna": 26000000,
        'Tunezja': 12000000,
        'Bangladesz': 171000000,
        'Kostaryka': 5200000,
        'Turcja': 85000000,
        "Bia2oru5b": 9400000,
        'Kuba': 11200000,
        'Ukraina': 41000000,
        'Boliwia': 12000000,
        'Liban': 5500000,
        'Brazylia': 214000000,
        'Bulgaria': 6800000,
        'Chile': 19600000,
        'Chiny': 1412000000,
        'Chorwacja': 3900000,
        'Cypr': 1250000,
        'Czad': 18000000,
        'Czechy': 10700000,
        'Dania': 5900000,
        'Dominikana': 11000000,
        'Egipt': 110000000,
        'Ekwador': 18000000,
        'Etiopia': 120000000,
        'Liberia': 5300000,
        'Libia': 7000000,
        'Madagaskar': 29000000,
        'Malediwy': 520000,
        'Malezja': 33000000,
        'Maroko': 37000000,
        'Mauritius': 1300000,
        'Meksyk': 128000000,
        'Mongolia': 3400000,
        'Mozambik': 33000000,
        'Namibia': 2600000,
        'Nepal': 30000000,
        'Niemcy': 84000000,
        'Urugwaj': 3500000,
        'Uzbekistan': 36000000,
        'Wenezuela': 28900000,
        "W9gry": 9600000,
        'Wielka Brytania': 67000000,
        'Wietnam': 98000000,
        "W2ochy": 59000000,
        'Zambia': 20000000,
        'Zimbabwe': 16000000,
        'Filipiny': 113000000,
        'Finlandia': 5500000,
        'Francja': 68000000,
        'Niger': 26000000,
        'Nigeria': 223000000,
        'Nikaragua': 7000000,
        'Grecja': 10400000,
        'Gruzja': 3700000,
        'Gwatemala': 18000000,
        'Hiszpania': 48000000,
        'Holandia': 17800000,
        'Indie': 1428000000,
        'Indonezja': 275000000,
        'Irak': 44000000,
        'Iran': 89000000,
        'Norwegia': 5400000,
        'Nowa Zelandia': 5200000,
        'Oman': 4600000,
        'Pakistan': 240000000,
        'Panama': 4500000,
        'Papua-Nowa Gwinea': 9500000,
        'Paragwaj': 7200000,
        'Peru': 34000000,
        'Polska': 38000000,
        'Irlandia': 5100000,
        'Portugalia': 10300000,
        'Islandia': 380000,
        'Rosja': 146000000,
        'Izrael': 9700000,
        'Rumunia': 19000000,
        'Jamajka': 2900000,
        'Seszele': 100000,
        'Japonia': 125000000,
        'Singapur': 5700000
      };

      let filtered = [...COUNTRY_DATA];

      function renderCountryList(items) {
        countryListEl.innerHTML = '';
        for (const c of items) {
          const li = document.createElement('li');
          const id = `item-${c.name.replace(/\s+/g, '-')}`;
          li.innerHTML = `
            <input type="checkbox" id="${id}" data-name="${c.name}" />
            <label for="${id}">${c.name}</label>
          `;
          countryListEl.appendChild(li);
        }
        // Ustaw maksymalną wartość i ogranicz bieżącą dla pola "X"
        if (pickCountEl) {
          pickCountEl.max = String(items.length);
          const current = parseInt(pickCountEl.value || '0', 10);
          const max = items.length || 1;
          if (!Number.isFinite(current) || current < 1) {
            pickCountEl.value = String(Math.min(10, max));
          } else if (current > max) {
            pickCountEl.value = String(max);
          }
        }
      }

      function applySort(items) {
        const mode = sortEl?.value || 'name-asc';
        const arr = [...items];
        if (mode === 'name-asc') arr.sort((a,b) => a.name.localeCompare(b.name, 'pl'));
        else if (mode === 'name-desc') arr.sort((a,b) => b.name.localeCompare(a.name, 'pl'));
        else if (mode === 'pop-desc') arr.sort((a,b) => (POP_BY_COUNTRY[b.name] ?? 0) - (POP_BY_COUNTRY[a.name] ?? 0));
        else if (mode === 'pop-asc') arr.sort((a,b) => (POP_BY_COUNTRY[a.name] ?? 0) - (POP_BY_COUNTRY[b.name] ?? 0));
        return arr;
      }

      renderCountryList(applySort(filtered));
      applyLayout();

      searchEl.addEventListener('input', () => {
        const q = searchEl.value.trim().toLowerCase();
        filtered = COUNTRY_DATA.filter(c => c.name.toLowerCase().includes(q));
        renderCountryList(applySort(filtered));
      });

      sortEl.addEventListener('change', () => {
        renderCountryList(applySort(filtered));
      });

      selectAllBtn.addEventListener('click', () => {
        countryListEl.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true);
      });
      deselectAllBtn.addEventListener('click', () => {
        countryListEl.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
      });

      // Wybierz X pierwszych krajów z aktualnej listy (po sortowaniu i filtrze)
      pickTopBtn.addEventListener('click', () => {
        const checkboxes = Array.from(countryListEl.querySelectorAll('input[type="checkbox"]'));
        const max = checkboxes.length;
        const n = Math.max(0, Math.min(parseInt(pickCountEl.value, 10) || 0, max));
        checkboxes.forEach((cb, i) => cb.checked = i < n);
      });

      function getSelectedCountries() {
        const names = Array.from(countryListEl.querySelectorAll('input[type="checkbox"]'))
          .filter(cb => cb.checked)
          .map(cb => cb.dataset.name);
        const set = new Set(names);
        return COUNTRY_DATA.filter(c => set.has(c.name));
      }

      // --- Mapa --- (bez etykiet miast/państw)
      const map = L.map('map', {
        zoomControl: true,
        worldCopyJump: true
      }).setView([30, 10], 2);

      // CartoDB Positron (No Labels)
      const tiles = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> kontrybutorzy &copy; <a href="https://carto.com/attributions">CARTO</a>',
        subdomains: 'abcd',
        maxZoom: 19
      }).addTo(map);

      // --- Quiz ---
      let running = false;
      let queue = [];
      let currentIndex = 0;
      let score = 0;
      let markerLayer = L.layerGroup().addTo(map);
      const markerByName = new Map();
      const REQUEUE_GAP = 3; // po ilu pytaniach ponowić próbę

      const baseMarkerStyle = { radius: 7, color: '#374151', weight: 1.25, fillColor: '#6b7280', fillOpacity: 0.95 };
      const correctStyle = { color: '#14532d', fillColor: '#22c55e' };
      const wrongStyle = { color: '#7f1d1d', fillColor: '#ef4444' };
      const hintStyle = { color: '#1e3a8a', fillColor: '#60a5fa' };

      function shuffle(arr) { return arr.sort(() => Math.random() - 0.5); }

      function showToast(text) {
        toastEl.textContent = text;
        toastEl.style.display = 'block';
        clearTimeout(showToast._t);
        showToast._t = setTimeout(() => { toastEl.style.display = 'none'; }, 1200);
      }

      // --- Tryby quizu i pomocnicze ---
      let quizMode = 'click';
      let remainingNames = new Set();
      let nameIndex = new Map(); // normalized -> original
      let solvedNames = new Set();
      let hintedName = null;

      function normalizeName(s) {
        try {
          return s
            .toString()
            .trim()
            .toLowerCase()
            .normalize('NFD')
            .replace(/[\u0300-\u036f]/g, '') // usuń diakrytyki
            .replace(/[-'’`]/g, ' ') // łączniki/apostrofy → spacje
            .replace(/[^a-zA-ZąćęłńóśźżĄĆĘŁŃÓŚŹŻ\s]/g, '') // zostaw litery i spacje
            .replace(/\s+/g, ' ')
            .trim();
        } catch(_) { return s.toString().trim().toLowerCase(); }
      }

      // Dodatkowe akceptowane nazwy (aliasy) dla trybu "Wpisywanie wskazanego"
      const ALT_NAMES = {
        'Wielka Brytania': ['Anglia', 'GB', 'UK', 'Zjednoczone Królestwo', 'Wlk Brytania', 'Wlk. Brytania', 'Great Britain', 'United Kingdom'],
        'Stany Zjednoczone': ['USA', 'US', 'U.S.A.', 'Stany', 'Ameryka', 'Stany Zjednoczone Ameryki']
      };

      function acceptedNamesFor(canonicalName) {
        const set = new Set([normalizeName(canonicalName)]);
        try {
          const arr = ALT_NAMES[canonicalName] || [];
          for (const alt of arr) set.add(normalizeName(alt));
        } catch(_) {}
        return set;
      }

      function refreshQuizUiMode() {
        if (quizMode === 'type') {
          if (typeof targetContainer !== 'undefined' && targetContainer) targetContainer.style.display = 'none';
          if (typeof typeBox !== 'undefined' && typeBox) typeBox.style.display = 'flex';
          if (typeof idkBtn !== 'undefined' && idkBtn) idkBtn.style.display = 'none';
        } else if (quizMode === 'type-target') {
          if (typeof targetContainer !== 'undefined' && targetContainer) targetContainer.style.display = 'none';
          if (typeof typeBox !== 'undefined' && typeBox) typeBox.style.display = 'flex';
          if (typeof idkBtn !== 'undefined' && idkBtn) idkBtn.style.display = '';
        } else {
          if (typeof targetContainer !== 'undefined' && targetContainer) targetContainer.style.display = '';
          if (typeof typeBox !== 'undefined' && typeBox) typeBox.style.display = 'none';
          if (typeof idkBtn !== 'undefined' && idkBtn) idkBtn.style.display = 'none';
        }
      }

      function updateTypeTargetHint() {
        if (quizMode !== 'type-target') return;
        // Nowe pytanie – wyczyść poprzedni komunikat w HUD
        showHudMessage('');
        // Przywróć poprzedni hint jeśli nie został rozwiązany
        if (hintedName && !solvedNames.has(hintedName)) {
          const prevM = markerByName.get(hintedName);
          if (prevM) prevM.setStyle({ ...baseMarkerStyle });
        }
        const target = queue[currentIndex];
        if (!target) return;
        const m = markerByName.get(target.name);
        if (m) {
          m.setStyle({ ...baseMarkerStyle, ...hintStyle });
          hintedName = target.name;
          // Przybliż mapę na wskazany kraj
          try {
            const ll = typeof m.getLatLng === 'function' ? m.getLatLng() : null;
            if (ll && typeof map !== 'undefined') {
              const currentZ = (map.getZoom && map.getZoom()) || 2;
              const targetZ = Math.max(currentZ, 4.5);
              if (map.flyTo) map.flyTo(ll, targetZ, { duration: 0.6 });
              else if (map.setView) map.setView(ll, targetZ);
            }
          } catch(_) {}
        } else {
          hintedName = null;
        }
      }

      function showTempLabelFor(name) {
        try {
          const m = markerByName.get(name);
          if (!m) return;
          if (m._tempLabelTimer) clearTimeout(m._tempLabelTimer);
          m.bindTooltip(String(name), { direction: 'top', offset: [0, -8], opacity: 0.95 }).openTooltip();
          m._tempLabelTimer = setTimeout(() => {
            try { m.unbindTooltip(); } catch(_){}
          }, 1200);
        } catch(_){}
      }

      function showHudMessage(text, ms = null) {
        if (!hudMsgEl) return;
        if (!text) {
          hudMsgEl.style.display = 'none';
          hudMsgEl.textContent = '';
          if (showHudMessage._t) clearTimeout(showHudMessage._t);
          return;
        }
        hudMsgEl.textContent = text;
        hudMsgEl.style.display = '';
        if (showHudMessage._t) clearTimeout(showHudMessage._t);
        if (Number.isFinite(ms) && ms > 0) {
          showHudMessage._t = setTimeout(() => {
            try {
              hudMsgEl.style.display = 'none';
              hudMsgEl.textContent = '';
            } catch(_){}
          }, ms);
        }
      }

      function updateHUD() {
        scoreEl.textContent = String(score);
        progressEl.textContent = `${Math.min(currentIndex, queue.length)}/${queue.length}`;
        targetNameEl.textContent = queue[currentIndex]?.name ?? '—';
      }

      function setUiDisabled(disabled) {
        startBtn.disabled = disabled;
        countryListEl.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.disabled = disabled);
        searchEl.disabled = disabled;
        selectAllBtn.disabled = disabled;
        deselectAllBtn.disabled = disabled;
        if (pickCountEl) pickCountEl.disabled = disabled;
        if (pickTopBtn) pickTopBtn.disabled = disabled;
        if (typeof modeEl !== 'undefined' && modeEl) modeEl.disabled = disabled;
      }

      // Tryb mobilny: na telefonie najpierw tylko wybieranie, potem tylko mapa

      function isMobile() { return window.matchMedia('(max-width: 768px)').matches; }

      function applyLayout() {
        if (isMobile()) {
          if (running) {
            if (sidebarEl) sidebarEl.style.display = 'none';
            if (mainEl) mainEl.style.display = 'flex';
            // Po pokazaniu mapy z ukrycia przelicz jej wymiary
            setTimeout(() => {
              try {
                if (typeof map !== 'undefined' && map.invalidateSize) {
                  map.invalidateSize();
                  if (typeof fitToMarkers === 'function') fitToMarkers();
                }
              } catch(_){}
            }, 50);
          } else {
            if (sidebarEl) sidebarEl.style.display = 'flex';
            if (mainEl) mainEl.style.display = 'none';
          }
        } else {
          if (sidebarEl) sidebarEl.style.display = 'flex';
          if (mainEl) mainEl.style.display = 'flex';
          // Na desktopie również upewnij się, że mapa ma właściwy rozmiar po zmianie układu
          setTimeout(() => {
            try {
              if (typeof map !== 'undefined' && map.invalidateSize) map.invalidateSize();
            } catch(_){}
          }, 50);
        }
      }

      window.addEventListener('resize', applyLayout);

      function clearMarkers() {
        markerLayer.clearLayers();
        markerByName.clear();
      }

      function fitToMarkers() {
        if (markerLayer.getLayers().length === 0) return;
        try {
          const bounds = L.featureGroup(markerLayer.getLayers()).getBounds();
          if (bounds.isValid()) {
            map.fitBounds(bounds.pad(0.2));
          }
        } catch (_) {}
      }

      function onMarkerClick(country, marker) {
        if (!running) return;
        if (quizMode !== 'click') return;
        const target = queue[currentIndex];
        if (!target) return;

        const isCorrect = country.name === target.name;
        if (isCorrect) {
          marker.setStyle(correctStyle);
          marker.off('click');
          score += 1;
          currentIndex += 1;
          if (currentIndex >= queue.length) {
            updateHUD();
            running = false;
            setUiDisabled(false);
            showToast(`Koniec! Wynik: ${score}/${queue.length}`);
            targetNameEl.textContent = '—';
            return;
          }
          updateHUD();
        } else {
          const prev = { ...baseMarkerStyle };
          marker.setStyle({ ...baseMarkerStyle, ...wrongStyle });
          setTimeout(() => marker.setStyle(prev), 450);

          // Podświetl prawidłowy kraj na chwilę
          const correctMarker = markerByName.get(target.name);
          if (correctMarker) {
            const prevCorrect = { ...baseMarkerStyle };
            correctMarker.setStyle({ ...baseMarkerStyle, color: '#1e3a8a', fillColor: '#60a5fa' });
            setTimeout(() => correctMarker.setStyle(prevCorrect), 750);
            showTempLabelFor(target.name);
          }

          // Zawsze requeue: wstaw ponownie za kilka pytań
          const [cur] = queue.splice(currentIndex, 1);
          const insertAt = Math.min(queue.length, currentIndex + REQUEUE_GAP);
          queue.splice(insertAt, 0, cur);
          showToast('Błąd. Spróbujesz ponownie za kilka pytań.');

          // currentIndex wskazuje teraz kolejny element; jeśli nic nie zostało – zakończ
          if (currentIndex >= queue.length) {
            updateHUD();
            running = false;
            setUiDisabled(false);
            showToast(`Koniec! Wynik: ${score}/${queue.length}`);
            targetNameEl.textContent = '�?"';
            return;
          }
          updateHUD();
        }
      }

      function startQuiz() {
        const selected = getSelectedCountries();
        quizMode = (typeof modeEl !== 'undefined' && modeEl && modeEl.value) ? modeEl.value : 'click';
        if (selected.length < 2) {
          showToast('Wybierz co najmniej 2 państwa.');
          return;
        }

        running = true;
        hud.style.display = 'flex';
        showHudMessage('');
        score = 0;
        currentIndex = 0;
        queue = shuffle([...selected]);
        updateHUD();
        setUiDisabled(true);
        applyLayout();

        clearMarkers();
        for (const country of selected) {
          const marker = L.circleMarker([country.lat, country.lng], baseMarkerStyle);
          marker.on('click', () => onMarkerClick(country, marker));
          marker.addTo(markerLayer);
          markerByName.set(country.name, marker);
        }
        if (quizMode === 'type') {
          remainingNames = new Set();
          nameIndex = new Map();
          for (const c of selected) {
            const norm = normalizeName(c.name);
            remainingNames.add(norm);
            nameIndex.set(norm, c.name);
          }
          refreshQuizUiMode();
          try { answerInput && answerInput.focus(); } catch(_) {}
        } else if (quizMode === 'type-target') {
          solvedNames = new Set();
          hintedName = null;
          refreshQuizUiMode();
          updateTypeTargetHint();
          try { answerInput && answerInput.focus(); } catch(_) {}
        } else {
          refreshQuizUiMode();
        }
        fitToMarkers();
        setTimeout(() => { try { if (typeof map !== 'undefined' && map.invalidateSize) { map.invalidateSize(); fitToMarkers(); } } catch(_){} }, 50);
      }

      function onAnswerSubmit() {
        if (!running) return;
        const raw = (answerInput?.value || '').trim();
        if (!raw) return;
        const norm = normalizeName(raw);

        if (quizMode === 'type') {
          if (remainingNames.has(norm)) {
            remainingNames.delete(norm);
            const original = nameIndex.get(norm) || raw;
            const m = markerByName.get(original);
            if (m) m.setStyle({ ...baseMarkerStyle, ...correctStyle });
            score += 1;
            currentIndex = score;
            answerInput.value = '';
            showToast(`Dobrze! (${score}/${queue.length})`);
            if (score >= queue.length) {
              updateHUD();
              refreshQuizUiMode();
              running = false;
              setUiDisabled(false);
              showToast(`Koniec! Wynik: ${score}/${queue.length}`);
            } else {
              updateHUD();
              refreshQuizUiMode();
            }
          } else {
            showToast('Brak na liście zaznaczonych. Spróbuj ponownie.');
          }
          return;
        }

        if (quizMode === 'type-target') {
          const target = queue[currentIndex];
          if (!target) return;
          const accepted = acceptedNamesFor(target.name);
          const isCorrect = accepted.has(norm);
          if (isCorrect) {
            const m = markerByName.get(target.name);
            if (m) m.setStyle({ ...baseMarkerStyle, ...correctStyle });
            solvedNames.add(target.name);
            score += 1;
            currentIndex += 1;
            answerInput.value = '';
            if (currentIndex >= queue.length) {
              updateHUD();
              refreshQuizUiMode();
              running = false;
              setUiDisabled(false);
              showToast(`Koniec! Wynik: ${score}/${queue.length}`);
              targetNameEl.textContent = '—';
              return;
            }
            showHudMessage(`To było: ${target.name}`);
            updateHUD();
            refreshQuizUiMode();
            updateTypeTargetHint();
            showToast(`Błąd. To było: ${target.name}. Spróbujesz ponownie za kilka pytań.`);
          } else {
            // Pokaż etykietę poprawnego kraju na chwilę
            showTempLabelFor(target.name);
            // Requeue za kilka pytań
            const [cur] = queue.splice(currentIndex, 1);
            const insertAt = Math.min(queue.length, currentIndex + REQUEUE_GAP);
            queue.splice(insertAt, 0, cur);
            showToast('Błąd. Spróbujesz ponownie za kilka pytań.');
            updateHUD();
            refreshQuizUiMode();
            updateTypeTargetHint();
          }
        }
      }

      function onIDontKnow() {
        if (!running || quizMode !== 'type-target') return;
        const target = queue[currentIndex];
        if (!target) return;
        // Pomiń jak błąd: przenieś pytanie dalej
        const [cur] = queue.splice(currentIndex, 1);
        const insertAt = Math.min(queue.length, currentIndex + REQUEUE_GAP);
        queue.splice(insertAt, 0, cur);
        answerInput && (answerInput.value = '');
        showToast('Pominięto. Spróbujesz ponownie za kilka pytań.');
        updateHUD();
        refreshQuizUiMode();
        updateTypeTargetHint();
      }

      function resetQuiz() {
        running = false;
        setUiDisabled(false);
        hud.style.display = 'none';
        targetNameEl.textContent = '—';
        score = 0;
        currentIndex = 0;
        queue = [];
        updateHUD();
        clearMarkers();
        // Przywróć UI trybu
        try {
          if (typeof typeBox !== 'undefined' && typeBox) typeBox.style.display = 'none';
          if (typeof targetContainer !== 'undefined' && targetContainer) targetContainer.style.display = '';
          if (typeof answerInput !== 'undefined' && answerInput) answerInput.value = '';
          quizMode = 'click';
          solvedNames = new Set();
          hintedName = null;
        } catch(_) {}
        applyLayout();
      }

      startBtn.addEventListener('click', startQuiz);
      resetBtn.addEventListener('click', resetQuiz);
      if (typeof answerBtn !== 'undefined' && answerBtn) answerBtn.addEventListener('click', onAnswerSubmit);
      if (typeof answerInput !== 'undefined' && answerInput) answerInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') onAnswerSubmit(); });
      if (typeof idkBtn !== 'undefined' && idkBtn) idkBtn.addEventListener('click', onIDontKnow);

      // Przy pierwszym uruchomieniu: nic nie startujemy
    </script>
  </body>
  </html>
